<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="lore-entries">
    <template>
        <style>
            :host {
                display: block;
                overflow: hidden;
            }

            article {
                margin: 5px;
                float: left;
            }

            h1, h1 a {
                font-family: "Jockey One", sans-serif;
                font-weight: 100;
                color: #aae8fd;
                font-size: 30px;
                text-transform: uppercase;
                text-decoration: none;
            }

            h2 {
                color: #a19ba6;
                font-weight: 300;
                font-style: italic;
                font-size: 12px;
                margin-left: 10px;
            }

            .item {
                background: rgba(0, 0, 0, .7);
                border: 1px solid #3e3e47;
                border-radius: 5px;
                -webkit-font-smoothing: antialiased;
                text-rendering: optimizeLegibility;
                font-size: 14px;
                font-weight: 300;
                letter-spacing: 3px;
                min-height: 48px;
            }

            .item paper-item {
                color: #a19ba6;
                font-weight: 300;
                letter-spacing: 2px;
                line-height: 24px;
                text-decoration: none;
                cursor: pointer;
                padding: 0 5px 0 0;
            }

            .item paper-item:hover {
                color: #aae8fd;
                background: #000000;
            }

            .item paper-item:focus {
                color: #aae8fd;
                background: #000000;
            }

            .item paper-item span {
                width: 32px;
                height: 24px;
                margin: 10px;
                text-align: center;
            }

            .item div {
                border-top: 1px solid #3e3e47;
                border-bottom: 1px solid #3e3e47;
                padding: 10px;
                color: #C0BDD7;
            }

            .item footer {
                background: #000000;
                color: #a19ba6;
                font-size: 10px;
                text-align: right;
            }

            .item footer a {
                color: #a19ba6;
                text-decoration: none;
            }

            .item footer a:hover {
                color: #aae8fd;
                text-decoration: none;
            }
        </style>

        <iron-ajax id="jsonFile"
                   handle-as="json"
                   last-response="{{entries}}"
                   on-response="handleResponse"
                   auto></iron-ajax>

        <iron-ajax url=".{{baseUrl}}/data/scopes.json" last-response="{{scopes}}" auto></iron-ajax>

        <article><h1><a data-route="{{category}}" href="./{{baseUrl}}{{category}}">{{category}}</a>: {{jsonfile}}</h1></article>

            <template is="dom-repeat" items="{{entries}}" as="entry" sort="sortScope" filter="hasScope">
                <article>
                    <div class="item">
                        <paper-item center-justified onclick="toggle(this)" id="#item{{jsonfile}}{{index}}">
                          <span>
                            <img src="images/icons/icon-{{entry.sourcetype}}.png"
                                 alt="{{entry.sourcetype}}"
                                 width="24px"
                                 height="24px">
                          </span>
                            {{entry.headline}}
                        </paper-item>
                        <iron-collapse id="item{{jsonfile}}{{index}}" tabindex="{{index}}">
                            <template is="dom-repeat" items="{{scopes}}" as="scope">
                                <template is="dom-if"  if="[[isScope(scope.id,entry.scope)]]">
                                    <h2>Scope: {{scope.label}}</h2>
                                </template>
                            </template>
                            <div id="articlecontent" inner-h-t-m-l="{{entry.content}}"></div>
                            <footer>
                                <template is="dom-if"  if="[[isLink(entry.source)]]">
                                    Source: <a href="{{entry.source}}" target="_blank">{{entry.sourcetype}}</a>
                                </template>
                                <template is="dom-if"  if="[[isNotLink(entry.source)]]">
                                    Source: {{entry.sourcetype}}
                                </template>
                            </footer>
                        </iron-collapse>
                    </div>
                </article>
            </template>
    </template>

    <script>
        (function () {
            'use strict';
            Polymer({
                is: 'lore-entries',
                properties: {
                    jsonfile: String,
                    category: String,
                    selector: String,
                    items: {
                        type: Array,
                        reflectToAttribute: true,
                        notify: true
                    }
                },
                ready: function () {
                    this.$.jsonFile.url = 'data/lore-' + this.jsonfile + '.json';
                    this.$.jsonFile.generateRequest();
                },
                handleResponse: function (request) {
                    this.items = request.detail.response;
                },
                sortScope: function(foo, bar) {
                    if ( foo.scope < bar.scope) {
                        return -1;
                    } else {
                        return 1;
                    }
                },
                hasScope: function (entry) {
                    if (!entry) return false;
                    return entry.scope;
                },
                isScope: function (scopeid,entryscope) {
                    return scopeid === entryscope;
                },
                isLink: function (entrysource) {
                    var pattern = /^((http|https):\/\/)/;

                    if(pattern.test(entrysource)) {
                        return true;
                    }
                },
                isNotLink: function (entrysource) {
                    var pattern = /^((http|https):\/\/)/;

                    if(!pattern.test(entrysource)) {
                        return true;
                    }
                }
            });
        })();

        function toggle(e) {
            document.querySelector(e.id).toggle();
        }
    </script>
</dom-module>